{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Reportes - Sistema de Detección de Anemia{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
{% endblock %}

{% block content %}
<div class="reports-container">
  <!-- Header -->
  <div class="reports-header">
    <h1 class="reports-title">Mis Reportes</h1>
  </div>

  <!-- Barra de búsqueda -->
  <div class="search-section">
    <form method="get" class="search-form">
      <input 
        type="text" 
        name="search" 
        class="search-input" 
        placeholder="Buscar por Nombre, Correo o ID de paciente..."
        value="{{ search_query }}"
      >
      <button type="submit" class="btn-search">Buscar</button>
    </form>
  </div>

  <!-- Grid de Reportes -->
  {% if reportes %}
    <div class="reports-grid">
      {% for reporte in reportes %}
        <div class="report-card">
          <!-- Header del card -->
          <div class="report-card-header">
            <svg class="report-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM9 17H7V10H9V17ZM13 17H11V7H13V17ZM17 17H15V13H17V17Z" fill="white"/>
            </svg>
            <span class="report-header-title">imagen detectada {{ forloop.counter }}</span>
          </div>

          <!-- Cuerpo del card -->
          <div class="report-card-body">
            <div class="report-type">Reporte anemia</div>
            
            <div class="report-info-group">
              <div class="report-info-item">
                <span class="report-label">Paciente:</span>
                <span class="report-value">{{ reporte.paciente.nombre_completo|lower }}</span>
              </div>
              
              <div class="report-info-item">
                <span class="report-label">Fecha:</span>
                <span class="report-value">{{ reporte.fecha_analisis|date:"d \d\e F, Y" }}</span>
              </div>

              <div class="report-info-item">
                <span class="report-label">Diagnóstico:</span>
                <span class="report-value">{{ reporte.grado_palidez }}</span>
              </div>

              <div class="report-info-item">
                <span class="report-label">Confianza:</span>
                <span class="report-value">{{ reporte.confianza|floatformat:1 }}%</span>
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="report-actions">
              <a href="{% url 'core:report_detail' reporte.id %}" class="btn-action btn-detail">
                Ver Detalle
              </a>
              
              <button 
                type="button" 
                class="btn-action btn-delete"
                onclick="confirmDelete({{ reporte.id }}, '{{ reporte.paciente.nombre_completo }}')"
              >
                Eliminar PDF
              </button>
              
              <button 
                type="button" 
                class="btn-action btn-email"
                onclick="sendEmail({{ reporte.id }}, '{{ reporte.paciente.correo }}')"
              >
                Enviar Email
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Paginación -->
    {% if reportes.has_other_pages %}
      <div class="pagination">
        <div class="pagination-info">
          Mostrando {{ reportes.start_index }} - {{ reportes.end_index }} de {{ total_reportes }} reportes
        </div>
        
        <div class="pagination-controls">
          {% if reportes.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" class="page-link page-first">
              &laquo;&laquo;
            </a>
            <a href="?page={{ reportes.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-link">
              &laquo;
            </a>
          {% else %}
            <span class="page-link page-disabled">&laquo;&laquo;</span>
            <span class="page-link page-disabled">&laquo;</span>
          {% endif %}

          {% for num in reportes.paginator.page_range %}
            {% if reportes.number == num %}
              <span class="page-link page-current">{{ num }}</span>
            {% elif num > reportes.number|add:'-3' and num < reportes.number|add:'3' %}
              <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-link">
                {{ num }}
              </a>
            {% endif %}
          {% endfor %}

          {% if reportes.has_next %}
            <a href="?page={{ reportes.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-link">
              &raquo;
            </a>
            <a href="?page={{ reportes.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-link page-last">
              &raquo;&raquo;
            </a>
          {% else %}
            <span class="page-link page-disabled">&raquo;</span>
            <span class="page-link page-disabled">&raquo;&raquo;</span>
          {% endif %}
        </div>
      </div>
    {% endif %}

  {% else %}
    <!-- Mensaje cuando no hay reportes -->
    <div class="no-reports">
      <svg class="no-reports-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14 2H6C4.9 2 4.01 2.9 4.01 4L4 20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM16 18H8V16H16V18ZM16 14H8V12H16V14ZM13 9V3.5L18.5 9H13Z" fill="currentColor"/>
      </svg>
      <p class="no-reports-text">
        {% if search_query %}
          No se encontraron reportes que coincidan con "{{ search_query }}"
        {% else %}
          No hay reportes disponibles
        {% endif %}
      </p>
      <a href="{% url 'core:analysis' %}" class="btn-create-report">
        Crear primer reporte
      </a>
    </div>
  {% endif %}
</div>

<!-- Modal de Confirmación para Eliminar -->
<div id="deleteModal" class="modal">
  <div class="modal-content-small">
    <div class="modal-header-danger">
      <h3>Confirmar Eliminación</h3>
      <span class="close" onclick="closeDeleteModal()">&times;</span>
    </div>
    <div class="modal-body-small">
      <p>¿Estás seguro de que deseas eliminar el reporte de <strong id="patientName"></strong>?</p>
      <p class="warning-text">Esta acción no se puede deshacer.</p>
      
      <form id="deleteForm" method="post" class="modal-actions">
        {% csrf_token %}
        <button type="button" class="btn-cancel" onclick="closeDeleteModal()">
          Cancelar
        </button>
        <button type="submit" class="btn-confirm-delete">
          Eliminar
        </button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Confirmar eliminación
function confirmDelete(reportId, patientName) {
  const modal = document.getElementById('deleteModal');
  const form = document.getElementById('deleteForm');
  const nameElement = document.getElementById('patientName');
  
  nameElement.textContent = patientName;
  form.action = `/reportes/${reportId}/eliminar/`;
  modal.style.display = 'block';
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteModal');
  modal.style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
  const modal = document.getElementById('deleteModal');
  if (event.target === modal) {
    closeDeleteModal();
  }
}

// Enviar email
function sendEmail(reportId, email) {
  if (confirm(`¿Enviar reporte por email a ${email}?`)) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/reportes/${reportId}/enviar-email/`;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    
    form.appendChild(csrfInput);
    document.body.appendChild(form);
    form.submit();
  }
}

// Auto-ocultar mensajes
document.addEventListener('DOMContentLoaded', function() {
  const alerts = document.querySelectorAll('.alert');
  
  alerts.forEach(function(alert) {
    setTimeout(function() {
      alert.style.animation = 'slideOut 0.4s ease-out';
      
      setTimeout(function() {
        alert.remove();
      }, 400);
    }, 5000);
  });
});
</script>

<style>
@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(120%);
    opacity: 0;
  }
}
</style>
{% endblock %}
