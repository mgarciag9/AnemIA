{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Perfil - Sistema de Detección de Anemia{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
  <!-- Header -->
  <div class="profile-header">
    <h1 class="profile-title">Mi Perfil</h1>
    <p class="profile-subtitle">Gestiona tu información personal y configuración de cuenta</p>
  </div>

  <!-- Grid Principal -->
  <div class="profile-grid">
    <!-- Card de Información de Usuario (Izquierda) -->
    <div class="user-info-card">
      <div class="profile-photo-container">
        {% if user.profile_photo %}
          <img src="{{ user.profile_photo.url }}" alt="Foto de perfil">
        {% else %}
          <div class="profile-photo-default">
            {{ user.first_name.0|upper }}{{ user.last_name.0|upper }}
          </div>
        {% endif %}
      </div>
      
      <div class="user-name-display">
        <h2>{{ user.get_full_name }}</h2>
        <p class="user-email-display">{{ user.email }}</p>
      </div>

      <div class="user-role-badge">
        MÉDICO
      </div>
    </div>

    <!-- Secciones de Formularios (Derecha) -->
    <div class="profile-sections">
      
      <!-- Sección: Información Personal -->
      <div class="profile-section">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
          </svg>
          <h3 class="section-title">Información Personal</h3>
        </div>

        <form method="post" enctype="multipart/form-data" class="profile-form">
          {% csrf_token %}
          
          <!-- Upload de Foto -->
          <div class="form-group full-width">
            <div class="photo-upload-section">
              <div class="photo-preview-wrapper" onclick="document.getElementById('foto_perfil').click()">
                {% if user.profile_photo %}
                  <img id="photo-preview" src="{{ user.profile_photo.url }}" alt="Vista previa">
                {% else %}
                  <div id="photo-preview" class="photo-preview-default">
                    {{ user.first_name.0|upper }}{{ user.last_name.0|upper }}
                  </div>
                {% endif %}
              </div>
              
              <div class="photo-upload-info">
                <p class="photo-upload-text">Haz clic en la imagen para cambiarla</p>
                <p class="photo-upload-hint">JPG, PNG o GIF (máx. 5MB)</p>
              </div>

              <input 
                type="file" 
                id="foto_perfil" 
                name="profile_photo" 
                accept="image/*"
                class="file-input"
                onchange="previewPhoto(this)"
              >
            </div>
            {% if profile_form.profile_photo.errors %}
              <div class="error-message">{{ profile_form.profile_photo.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Nombre y Apellidos -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">{{ profile_form.first_name.label }}</label>
              <input 
                type="text" 
                name="first_name" 
                value="{{ user.first_name }}" 
                class="form-control {% if profile_form.first_name.errors %}error{% endif %}"
                placeholder="Ingrese su nombre"
                required
              >
              {% if profile_form.first_name.errors %}
                <div class="error-message">{{ profile_form.first_name.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="form-group">
              <label class="form-label">{{ profile_form.last_name.label }}</label>
              <input 
                type="text" 
                name="last_name" 
                value="{{ user.last_name }}" 
                class="form-control {% if profile_form.last_name.errors %}error{% endif %}"
                placeholder="Ingrese sus apellidos"
                required
              >
              {% if profile_form.last_name.errors %}
                <div class="error-message">{{ profile_form.last_name.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Email -->
          <div class="form-group full-width">
            <label class="form-label">{{ profile_form.email.label }}</label>
            <input 
              type="email" 
              name="email" 
              value="{{ user.email }}" 
              class="form-control {% if profile_form.email.errors %}error{% endif %}"
              placeholder="correo@ejemplo.com"
              required
            >
            {% if profile_form.email.errors %}
              <div class="error-message">{{ profile_form.email.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Teléfono y DNI -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">{{ profile_form.phone_number.label }}</label>
              <input 
                type="text" 
                name="phone_number" 
                value="{{ user.phone_number|default:'' }}" 
                class="form-control {% if profile_form.phone_number.errors %}error{% endif %}"
                placeholder="Ingrese su teléfono"
              >
              {% if profile_form.phone_number.errors %}
                <div class="error-message">{{ profile_form.phone_number.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="form-group">
              <label class="form-label">{{ profile_form.national_id.label }}</label>
              <input 
                type="text" 
                name="national_id" 
                value="{{ user.national_id|default:'' }}" 
                class="form-control {% if profile_form.national_id.errors %}error{% endif %}"
                placeholder="Ingrese su DNI"
              >
              {% if profile_form.national_id.errors %}
                <div class="error-message">{{ profile_form.national_id.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Ciudad y Sexo -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">{{ profile_form.city.label }}</label>
              <input 
                type="text" 
                name="city" 
                value="{{ user.city|default:'' }}" 
                class="form-control {% if profile_form.city.errors %}error{% endif %}"
                placeholder="Ingrese su ciudad"
              >
              {% if profile_form.city.errors %}
                <div class="error-message">{{ profile_form.city.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="form-group">
              <label class="form-label">{{ profile_form.gender.label }}</label>
              <select 
                name="gender" 
                class="form-control {% if profile_form.gender.errors %}error{% endif %}"
              >
                <option value="">Seleccione sexo</option>
                <option value="Masculino" {% if user.gender == "Masculino" %}selected{% endif %}>Masculino</option>
                <option value="Femenino" {% if user.gender == "Femenino" %}selected{% endif %}>Femenino</option>
                <option value="Otro" {% if user.gender == "Otro" %}selected{% endif %}>Otro</option>
              </select>
              {% if profile_form.gender.errors %}
                <div class="error-message">{{ profile_form.gender.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Dirección -->
          <div class="form-group full-width">
            <label class="form-label">{{ profile_form.address.label }}</label>
            <input 
              type="text" 
              name="address" 
              value="{{ user.address|default:'' }}" 
              class="form-control {% if profile_form.address.errors %}error{% endif %}"
              placeholder="Ingrese su dirección completa"
            >
            {% if profile_form.address.errors %}
              <div class="error-message">{{ profile_form.address.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Botones de Acción -->
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="window.location.reload()">
              Cancelar
            </button>
            <button type="submit" name="update_profile" class="btn-primary">
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>

      <!-- Sección: Cambiar Contraseña -->
      <div class="profile-section">
        <div class="section-header">
          <svg class="section-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 8H17V6C17 3.24 14.76 1 12 1C9.24 1 7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM12 17C10.9 17 10 16.1 10 15C10 13.9 10.9 13 12 13C13.1 13 14 13.9 14 15C14 16.1 13.1 17 12 17ZM15.1 8H8.9V6C8.9 4.29 10.29 2.9 12 2.9C13.71 2.9 15.1 4.29 15.1 6V8Z" fill="currentColor"/>
          </svg>
          <h3 class="section-title">Seguridad</h3>
        </div>

        <div class="info-box">
          <p class="info-box-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/>
            </svg>
            Cambiar Contraseña
          </p>
          <p class="info-box-text">
            Para mayor seguridad, asegúrate de usar una contraseña fuerte con al menos 8 caracteres.
          </p>
        </div>

        <form method="post" class="profile-form">
          {% csrf_token %}
          
          <!-- Contraseña Actual -->
          <div class="form-group full-width">
            <label class="form-label">{{ password_form.old_password.label }}</label>
            <div class="password-field-wrapper">
              <input 
                type="password" 
                name="old_password" 
                class="form-control {% if password_form.old_password.errors %}error{% endif %}"
                placeholder="Ingrese su contraseña actual"
                id="old_password"
              >
              <button type="button" class="toggle-password" onclick="togglePassword('old_password')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
                </svg>
              </button>
            </div>
            {% if password_form.old_password.errors %}
              <div class="error-message">{{ password_form.old_password.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Nueva Contraseña -->
          <div class="form-group full-width">
            <label class="form-label">{{ password_form.new_password1.label }}</label>
            <div class="password-field-wrapper">
              <input 
                type="password" 
                name="new_password1" 
                class="form-control {% if password_form.new_password1.errors %}error{% endif %}"
                placeholder="Ingrese nueva contraseña (mínimo 8 caracteres)"
                id="new_password1"
              >
              <button type="button" class="toggle-password" onclick="togglePassword('new_password1')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
                </svg>
              </button>
            </div>
            {% if password_form.new_password1.errors %}
              <div class="error-message">{{ password_form.new_password1.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Confirmar Nueva Contraseña -->
          <div class="form-group full-width">
            <label class="form-label">{{ password_form.new_password2.label }}</label>
            <div class="password-field-wrapper">
              <input 
                type="password" 
                name="new_password2" 
                class="form-control {% if password_form.new_password2.errors %}error{% endif %}"
                placeholder="Confirme la nueva contraseña"
                id="new_password2"
              >
              <button type="button" class="toggle-password" onclick="togglePassword('new_password2')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12C2.73 16.39 7 19.5 12 19.5C17 19.5 21.27 16.39 23 12C21.27 7.61 17 4.5 12 4.5ZM12 17C9.24 17 7 14.76 7 12C7 9.24 9.24 7 12 7C14.76 7 17 9.24 17 12C17 14.76 14.76 17 12 17ZM12 9C10.34 9 9 10.34 9 12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12C15 10.34 13.66 9 12 9Z" fill="currentColor"/>
                </svg>
              </button>
            </div>
            {% if password_form.new_password2.errors %}
              <div class="error-message">{{ password_form.new_password2.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- Botones de Acción -->
          <div class="form-actions">
            <button type="submit" name="change_password" class="btn-primary">
              Cambiar Contraseña
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Preview de foto antes de subir
function previewPhoto(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const preview = document.getElementById('photo-preview');
      
      // Si es un div con iniciales, reemplazar con img
      if (preview.classList.contains('photo-preview-default')) {
        const wrapper = preview.parentElement;
        wrapper.innerHTML = `<img id="photo-preview" src="${e.target.result}" alt="Vista previa">`;
      } else {
        // Si ya es una imagen, solo cambiar el src
        preview.src = e.target.result;
      }
    }
    
    reader.readAsDataURL(input.files[0]);
  }
}

// Toggle visibilidad de contraseña
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const type = field.getAttribute('type');
  
  if (type === 'password') {
    field.setAttribute('type', 'text');
  } else {
    field.setAttribute('type', 'password');
  }
}

// Auto-ocultar mensajes después de 5 segundos
document.addEventListener('DOMContentLoaded', function() {
  const alerts = document.querySelectorAll('.alert');
  
  alerts.forEach(function(alert) {
    setTimeout(function() {
      alert.style.animation = 'slideOut 0.4s ease-out';
      
      setTimeout(function() {
        alert.remove();
      }, 400);
    }, 5000);
  });
});
</script>

<style>
@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(120%);
    opacity: 0;
  }
}
</style>
{% endblock %}
